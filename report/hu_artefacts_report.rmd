---
title: "Guanyingdong Stone Artefact Assemblage Report"
author: "HY and BM"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
   bookdown::word_document2:
    fig_caption: yes
    reference_docx: templates/template.docx
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE)
```

```{r}
# read in the data
library(plyr)
library(dplyr)
library(knitr)
library(readxl)
# install.packages("readxl")
file_name <- "../data/artefacts (27 Jul 2016).xls" 
flakes <- read_excel(file_name, sheet = "flake basics")
cores <- read_excel(file_name, sheet = "core basics")
debris <- read_excel(file_name, sheet = "chunk&debris")
retouch <- read_excel(file_name, sheet = "retouch")
```

```{r}
# are the artefact numbers really unique?
# sum(duplicated(flakes$number))
# extract duplicated flakes 
flakes_duplicated <- flakes[ duplicated(flakes$number), ]

# remove from original data
flakes <- flakes[!duplicated(flakes$number), ]

# update the artefact ID so it's not duplicate
flakes_duplicated$number <- paste0(flakes_duplicated$number, "a")

# put back into original data 
flakes <- rbind(flakes, flakes_duplicated)

# do the same for the retouch...

# are the arteact numbers really unique?
# sum(duplicated(retouch$number))

# extract duplicated retouch 
retouch_duplicated <- retouch[ duplicated(retouch$number), ]

# remove from original data
retouch <- retouch[!duplicated(retouch$number), ]

# update the artefact ID so it's not duplicate
retouch_duplicated$number <- paste0(retouch_duplicated$number, "a")

# put back into original data 
retouch <- rbind(retouch, retouch_duplicated)

############
# basic details of the dataset
artefact_ids <- list(flake_ids = flakes$number,
                     core_ids = cores$number,
                     debris_ids = debris$number,
                     retouch_ids = retouch$number)



# how many unique artefacts?
totals_of_each_type <- lapply(artefact_ids, function(i) length(unique(i)))
count_unique_artefacts <- sum(unlist(totals_of_each_type))
# debris pieces that are  retouch pieces
debris_with_retouch <- intersect(artefact_ids$retouch_ids, artefact_ids$debris_ids)
proportion_debris_retouched <- length(debris_with_retouch) / count_unique_artefacts 
# proportion of each type
library(knitr)
type_table <- data.frame(type = names(as.data.frame(totals_of_each_type)),
                         count = as.numeric(as.data.frame(totals_of_each_type)),
                         proportion = round(as.numeric(prop.table(as.data.frame(totals_of_each_type))),3))
# add total row at the bottom
type_table$type <- as.character(type_table$type)
type_table <- rbind(type_table, c("total", count_unique_artefacts, round(sum(type_table$proportion),2)))
# print pretty table                         
# kable(type_table)
```


# Introduction 


A total of `r type_table$count[2]` cores, `r type_table$count[1]` flakes, `r type_table$count[4]` retouched pieces and `r type_table$count[3]` pieces of debris were identified. Guanyindong site is located in Guizhou 

## Raw materials

```{r rawmaterials}
flake_raw_material <- table(flakes$material)

#' Data frame of counts, frequences and proportion of values in a vector
#' 
#' @param x a vector

tbl_of_counts_and_props <- function(x){
  tbl <- table(x)
  res <- data.frame(tbl, 
                    round(prop.table(tbl) * 100, 2))
  colnames(res) <- c('Name', 'Count', 'Percentage', 'Proportion')
  res
}

raw_material_tbl <- tbl_of_counts_and_props(flakes$material)

```

The assemblage is dominated by chert (`r raw_material_tbl$Proportion[2]`%) followed by limestone (`r raw_material_tbl$Proportion[3]`%) and small amounts of basalt, sandstone and quartz. 


## Flakes

```{r flakebasics}
flake_length_mean <- round(mean(flakes$mass, na.rm = TRUE),1)

```


The average maximum length of the flakes is `r flake_length_mean` mm

## Cores

## Retouched pieces

## Levallois 

# Discussion

# Conclusion