---
title: "Guanyingdong Stone Artefact Assemblage Report"
author: "HY and BM"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
   bookdown::word_document2:
    fig_caption: yes
    reference_docx: templates/template.docx
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE)

```

```{r eval=TRUE, echo=FALSE}
# read in the data
library(plyr)
library(dplyr)
library(knitr)
library(readxl)
library(ggplot2)
library(tidyr)
library(purrr)
# set working direcoty to source
file_name <- "../data/artefacts_new_name.xls" 
quiet_read <- purrr::quietly(readxl::read_excel)
flakes <- quiet_read(file_name, sheet = "flake basics")$result
cores <- quiet_read(file_name, sheet = "core basics")$result
debris <- quiet_read(file_name, sheet = "chunk&debris")$result
retouch <- quiet_read(file_name, sheet = "retouch")$result
scar_direction <- quiet_read(file_name, sheet = "scar direction ")$result
```

```{r eval=TRUE, echo=FALSE}
# are the artefact numbers really unique?
# sum(duplicated(flakes$number))

# change the name of flakes by adding "f_"
flakes$number <- paste0( "f_", flakes$number)

# extract duplicated flakes 
flakes_duplicated <- flakes[ duplicated(flakes$number), ]

# remove from original data
flakes <- flakes[!duplicated(flakes$number), ]

# update the artefact ID so it's not duplicate
flakes_duplicated$number <- paste0(flakes_duplicated$number, "a")

# put back into original data 
flakes <- rbind(flakes, flakes_duplicated)

# do the same for the retouch...

# are the artefact numbers really unique?
#sum(duplicated(retouch$number))

retouch$number <- paste0( "f_", retouch$number)

# extract duplicated retouch 
retouch_duplicated <- retouch[ duplicated(retouch$number), ]

# remove from original data
retouch <- retouch[!duplicated(retouch$number), ]

# update the artefact ID so it's not duplicate
retouch_duplicated$number <- paste0(retouch_duplicated$number, "a")

# put back into original data 
retouch <- rbind(retouch, retouch_duplicated)


# do the same for the debris...

# are the artefact numbers really unique?
# sum(duplicated(debris$number))

debris$number <- paste0( "d_", debris$number)

# extract duplicated retouch 
debris_duplicated <- debris[ duplicated(debris$number), ]

# remove from original data
debris <- debris[!duplicated(debris$number), ]

# update the artefact ID so it's not duplicate
debris_duplicated$number <- paste0(debris_duplicated$number, "a")

# put back into original data 
debris <- rbind(debris, debris_duplicated)


# do the same for the core...

# are the artefact numbers really unique?
# sum(duplicated(cores$number))

cores$number <- paste0( "c_", cores$number)

# extract duplicated retouch 
cores_duplicated <- cores[ duplicated(cores$number), ]

# remove from original data
cores <- cores[!duplicated(cores$number), ]

# update the artefact ID so it's not duplicate
# cores_duplicated$number <- paste0(cores_duplicated$number, "a")

# put back into original data 
cores <- rbind(cores, cores_duplicated)



############
# basic details of the dataset
artefact_ids <- list(flake_ids = flakes$number,
                     core_ids = cores$number,
                     debris_ids = debris$number,
                     retouch_ids = retouch$number)



# how many unique artefacts?
totals_of_each_type <- lapply(artefact_ids, function(i) length(unique(i)))

#count_unique_artefacts <- sum(unlist(totals_of_each_type))

count_unique_artefacts <- length(unique(unlist(artefact_ids[1:3])))

# debris pieces that are  retouch pieces
### debris_with_retouch <- intersect(artefact_ids$retouch_ids, artefact_ids$debris_ids)

### proportion_debris_retouched <- length(debris_with_retouch) / count_unique_artefacts 

# flakes that are retouched pieces
flake_with_retouch <- intersect(artefact_ids$retouch_ids, artefact_ids$flake_ids)

proportion_flake_retouched <- length(flake_with_retouch) / count_unique_artefacts 


# proportion of each type
type_table <- data.frame(type = names(as.data.frame(totals_of_each_type)),
                         count = as.numeric(as.data.frame(totals_of_each_type)),
                         proportion = round(as.numeric(as.data.frame(totals_of_each_type)/count_unique_artefacts),3))

# add total row at the bottom
type_table$type <- as.character(type_table$type)

type_table <- rbind(type_table, c("total", count_unique_artefacts, round(sum(type_table$proportion),2)))
# total number of artefacts
total_number_of_artefacts <- as.numeric(type_table$count[type_table$type == "total"])

# print pretty table                         
# kable(type_table)
```


# Introduction 

The Guanyindong site, located in  Guanyindong village, Qianxi County of Guizhou Province (26°51′26″N, 105°58′7″E) at an elevation of 1464 m a.s.l., is a limestone cave site extending from east to west it was discovered by a team organized by the institute of Vertebrate Paleontology and Paleoanthropolgy (IVPP), Chinese Academy of Sciences in 1964. Several excavations were conducted in 1965, 1972 and 1973, yeilding   A total of `r type_table$count[2]` cores, `r type_table$count[1]` flakes, `r type_table$count[4]` retouched pieces and `r type_table$count[3]` pieces of debris were identified. 

Introduction of paleolithc research in south Asia (or China). 

Introduction the distribution of levollois technique (origin, dispersion, distribution). 

Prolem: East Asia, why people thought no levollois. Why studying this site is important. Aim in this study.

## Raw materials

```{r rawmaterials}
flake_raw_material <- table(flakes$material)

#' Data frame of counts, frequences and proportion of values in a vector
#' 
#' @param x a vector

tbl_of_counts_and_props <- function(x){
  tbl <- table(x)
  res <- data.frame(tbl, 
                    round(prop.table(tbl) * 100, 2))
  colnames(res) <- c('Name', 'Count', 'Percentage', 'Proportion')
  res
}

raw_material_tbl <- tbl_of_counts_and_props(flakes$material)

# raw materials of retouch pieces
retouch_flake_details <- 
flakes %>% 
left_join(retouch) %>% 
filter(!is.na(`number of layers`))
# how many chert flakes?

chert_flake<- sum(grepl("chert", flakes$material))


chert_ret<- flakes %>% 
  filter(grepl("chert", material)) %>%
  filter(grepl("ret", type)) %>% 
  nrow()
percentage_of_chert_tools <-round(chert_ret/chert_flake * 100, 2)

# how many retouched pieces were limestone

limestone_ret<- flakes %>% 
  filter(grepl("limestone", material)) %>%
  filter(grepl("ret", type)) %>% 
  nrow()

```
Previous research reported that the stone artefacts are preliminarily made of siliceous limestone, In my observation,the majority of siliceous limestone is classified as chert, therefore, the assemblage is dominated by chert (`r raw_material_tbl$Proportion[2]`%) followed by limestone (`r raw_material_tbl$Proportion[3]`%) and  basalt, sandstone and quartz  were only occasionally used and constitute % and % of the assemblage respectively. Although the chert selected varies slightly from color to texture, sub-classification is not conducted due to the consistence of their physical properties which are homogeneous without fracture, joint and constant hardness. Table? Shows the different types of stone artefact that chert and limestone were employed.  `r percentage_of_chert_tools` % chert flakes were retouched into stone tools indicating a high efficient exploit of this raw material, although it can be easily obtained nearby. In terms of retouched pieces, `r chert_ret` of them are made of chert, `r limestone_ret` of them are made from limestone. It is obvious that  hominins  intended to selected chert as optimal raw material to manufacture  stone tools. 


	flakes	Retouched flakes	cores	debris	total
Chert					
limestone					

The raw material source are mostly from local area that no further than 10km based on Leng and Li's investigation indicating the ability of local raw material guides the selectivity of kanppers . One possible chert source, located about 4 km (straight distence) is called Jinyan hill, where chert nodules are exposed on surface (Leng, 2001).For limestone and volcanic rocks like basalt and quartz are all from local mountain, river bed and exposed layers. The majority of raw material are accessable within 6 km (Li, 2009) suggesting  an relative small foraging territory. Leng also found that the natural chert, volcanic rock, and siliceous limestone nodules were generally larger than specimen from GYD. According to source investigation, ancient knappers were inclined to obtain raw material locally and traverl short distence to get access to raw material, besides, they were aware of raw material selection indicated by the preference of chert, which is easier control and has better flaking property as main knapping object. It also suggests that their foraging radius allows them to collect raw material and return to cave without overnight stop. 
 
## Flakes

```{r flakebasics}

names(flakes)[30] <- "comment"
complete_flakes <- 
flakes %>% 
  filter(!grepl("brk|break|proximal|ret|retouch|pebble|tanged", type))
n_complete_flakes <- nrow(complete_flakes)

flake_length_mean <- round(mean(flakes$length, na.rm = TRUE),1) #there are thousands of flakes
flake_thick_mean <- round(mean(flakes$`Oriented thickness`, na.rm = TRUE),1)

# dorsal flake scars
# we only want flakes that have 0 or more scars, no NA values
flake_scar_numbers <- flakes$`scar number`[!is.na(flakes$`scar number`)]
dorsal_flake_scar_mean <- round(mean(flake_scar_numbers), 2)
dorsal_flake_scar_sd <- round(sd(flake_scar_numbers), 2)
# looking at hist(flake_scar_numbers) I see that most flakes have 3 or fewer scars
# so we can say
flakes_with_4_or_less_scars <- round(sum(flake_scar_numbers <= 4) / length(flake_scar_numbers) * 100, 1)
# what about the relationship between number of flake scars and artefact size?
cor_flake_scars_and_mass <- 
with(flakes, cor(`scar number`, mass, use = "pairwise.complete.obs"))


# Flake platforms
flakes_platforms <- 
flakes %>% 
filter(!grepl("NA|0.000000|42.000000|mis", platform)) %>% filter(!grepl("ret|retouch|pebble", type)) %>% 
group_by(platform) %>% 
tally() %>% 
filter(!is.na(platform)) %>% 
mutate(perc = round(n/sum(n),3) * 100) %>% 
arrange(desc(perc))

# percentage of each platform type
cortex_plat_perc <- flakes_platforms[flakes_platforms$platform == "cotex", ]$perc
plain_plat_perc <- flakes_platforms[flakes_platforms$platform == "plain", ]$perc
dihederal_plat_perc <- flakes_platforms[flakes_platforms$platform == "dihederal", ]$perc
facet_plat_perc <- flakes_platforms[flakes_platforms$platform == "facet", ]$perc

flakes_platform_shape <- 
flakes %>% 
filter(!grepl("NA", `platform shape`)) %>% filter(!grepl("ret|retouch|pebble", type)) %>% 
group_by(`platform shape`) %>% 
tally() %>% 
filter(!is.na(`platform shape`)) %>% 
mutate(perc = round(n/sum(n),3) * 100) %>% 
arrange(desc(perc))

triangle_platshp_perc <- flakes_platform_shape[flakes_platform_shape$`platform shape` == "triangle", ]$perc

fusiform_platshp_perc <- flakes_platform_shape[flakes_platform_shape$`platform shape` == "sx", ]$perc

quadrangle_platshp_perc <- flakes_platform_shape[flakes_platform_shape$`platform shape` == "sb", ]$perc

CDG_platshp_perc <- flakes_platform_shape[flakes_platform_shape$`platform shape` == "CDG", ]$perc

average_scar_number <- round(mean(flake_scar_numbers, na.rm = FALSE), 2)


sd_scar_number<-round(sd(flake_scar_numbers, na.rm = FALSE), 2)

flakes_with_4_or_less_scars <- sum(flake_scar_numbers <= 4 )/length(flake_scar_numbers)*100


# Cortex percentage

flake_cortex_percentage <- flakes$`cortex percentage`[!is.na(flakes$`cortex percentage`)]

flakes_with_10_or_less_cortex<- sum(flake_cortex_percentage <= 10 )/length(flake_cortex_percentage)*100

# scar direction

#how many flakes have same scar direction as flaking direction ( == 1)

library(purrr)
scar_direction <- as_data_frame(map_if(scar_direction, is.character, as.numeric))
flakes_same_scar_direction <- 
scar_direction %>% 
  filter(`scar1 direction ` == 1 | # if this col == 1 or the next col, or the next 
         `scar2 direction` == 1 |  # | is the symbol for 'or'
         `scar3 direction` == 1 |
         `scar4 direction` == 1 |
         `scar5 direction` == 1 |
         `scar6 direction` == 1 |
         `scar7 direction` == 1 |
         `scar8 direction` == 1 |
         `scar9 direction ` == 1 |
         `scar10 direction` == 1) %>% 
  nrow()


# Thickness for flakes, by platform shape

new_flakes <- flakes[flakes$`platform shape` %in% c("CDG", "triangle", "sb", "sx"), ]

new_flakes[new_flakes == "sb"] = "quadrangle"

new_flakes[new_flakes == "sx"] = "fusiform"

ggplot(new_flakes, aes(`Thickness at 25% max dim`, colour = `platform shape`)) +
  geom_density()

# dorsal flake cortex
flake_cortex_perc <- flakes$`cortex percentage`[!is.na(flakes$`cortex percentage`)]
flakes_with_20pc_cortex <- round(sum(flake_cortex_perc <= 20) / length(flake_cortex_perc) * 100, 1)



# directions of flake scars



```

```{r, thicknessplot, fig.cap="Distribution of flake thickness at three points across the flake"}

flakes_L <-  
  mutate(flakes, L = ifelse(grepl("leva", type), "L", "N"))


# explore variation in thickness in these groups
line_weight <- 1
library(ggplot2)
thick_plot <- ggplot(flakes_L) +
  geom_density(aes(`Thickness at 25% max dim`), 
               colour = "red", 
               alpha = 0.3,
               size = line_weight) +
  geom_density(aes(`Thickness at 50% max dim`), 
               colour = "green", 
               alpha = 0.3,
               size = line_weight) +
  geom_density(aes(`Thickness at 75% max dim`), 
               colour = "blue", 
               alpha = 0.3, 
               size = line_weight) +
  xlab("Thickness (mm)") +
  theme_minimal() +
  ggtitle("Distribution of flake thickness")

# draw plot
thick_plot


```

```{r}
# the average thickness of platform 
average_platform_thickness <- round(mean(flakes$`platform thickness`, na.rm = TRUE),2)
# the average width of platform
average_platform_width <- round(mean(flakes$`platform width`, na.rm = TRUE),2)
```


We found `r nrow(flakes)` flake pieces including complete flake (`r n_complete_flakes`), retouched flake(`r n_complete_flakes`),  flake breaks(`r n_complete_flakes`),  and retouched flake breaks(`r n_complete_flakes`),. The average maximum length of the flakes pieces is `r flake_length_mean` mm, the average thickness is`r flake_thick_mean` mm. These figures suggest that the flake from GYD are thin, indicating  the ability of knapping control.  There are `r sum(flakes_platforms$n)` flakes or broken flake that have distinguishable platforms, that  can be divided into cortex (`r cortex_plat_perc` %), plain (`r plain_plat_perc` %), facet (`r facet_plat_perc`%), dihederal (`r dihederal_plat_perc` %%) and focus. One noticeable character of the flake assemblage is the relative higher prepared platform compared with other sites in China during Middle Palaeolithic. It indicates a high exploitation capacity of raw material, probably due either to technological capacity or raw material’s flaking property.  The average thickness of platform is `r average_platform_thickness`mm; the average width of platform is `r average_platform_width`mm.  The shapes of platform include triangle (`r triangle_platshp_perc` %), fusiform (`r fusiform_platshp_perc`%), quadrangle (`r quadrangle_platshp_perc`%) and CDG (`r CDG_platshp_perc`%) and with a small account of trapezoid ，rectangle and irregular. 

In order to explore the possible relationship between platform shape with flake thickness, we compared the platform shapes with thickness at 50 max dim. Fig? shows that thickness of flakes which have CDG platform shape is more concentrated around 10-15mm. Flakes with triangle platform shape is the thickest around 20mm. Fig? shows the relationship between platform shapes and flake dimension.   % of flakes dorsal side is partially covered with cortex. Most of The cortex is limited ranging from 5 to 10 percentage.  The average scar number is `r average_scar_number` while the standard deviation is `r sd_scar_number`. Flakes with 3 dorsal scars are the largest proportion.`r round(flakes_with_4_or_less_scars,0)`% flakes have scar number less than 4. It suggests that before hominins brought knapping products into the cave, they knapped the blank outside of the cave therefore the flakes are on the late stage of knapping and with less cortex. The directions of scars of 356 flakes are recorded.  We divided the directions into 8 sections. Among them, `r flakes_same_scar_direction` flakes have dorsal scars that with the same directions of the flake, following with opposite direction(%). We also found a number of centripetal scars (%). Figure \@ref(fig:thicknessplot) shows the thickness distribution at 25%. 50% and 75%.From the chart, we can infer that the thickness at 25% is the thinnest place and thickness at 50% and 75% shares the same max dimension. It indicates that the knappers have a good control over thickness that can make the thickness under a particular thickness range. Since the max points of thickness of these three places are all around 12mm in GYD, it is reasonable to conclude that the form flakes of GYD is well controlled and relative flat.  



```{r corebasics}

# number of platforms on cores
cores_platform_numbers <- 
  cores %>% 
  select(platform) %>% 
  group_by(platform) %>% 
  tally() %>% 
  filter(!is.na(platform)) %>% 
  mutate(perc = round(n / sum(n) * 100, 1))

single_platform <- cores_platform_numbers$perc[cores_platform_numbers$platform == 1]


```



## Cores

We found `r nrow(cores)` cores in the lithic assemblage. The average dimension is xxx and with an average weight of xxx g. This dimension is slightly larger than flakes indicating The average max dimensions of cores are xx mm.The flaking technique of GYD is free hand percussion with hard hammer.  Chert dominates the raw material of cores(%).  There are various geometries of cores including irregular(%), conic(%), column(%) and small account of wedged and circle.  According to the number of platform, there are 3 types of cores: single platform (%), double platform (%) and multiple platform (%). According to technological reduction, they can be classified as ordinary core (%), blade core (%), disc core (%) and Levallois core(%). Fig? shows the scar number of each core. The primary cores just produced 1-4 flake scars and then discarded. The cores that have more than 8 scars are occasionally shown. It suggests that the cores are not efficiently exploited. The average scar length is xxx mm which is .  Most of them are covered with zero(%) or low percentage cortex( %Fig?) . The cortex location is always on platform (%) and bottom (%). Fig? shows the types of platform. The majority of platform type is plain (%) which suggests that using former scars as platform to continue flaking following flakes is the main strategy of knapping.  Remarkably, there are a notable amount of facet platforms() which presented with higher frequency on Levallois, blade and discoid cores indicating predetermined strategy was applied on more complicated techniques. The majority of cores have 1 or 2 rotation which means after knapping from one platform and then make a rotation to find a new platform to keep flaking when the original platform is no longer suitable for further knapping.  The small number of rotations reinforced the observation that most of cores in GYD are casual cores either due to the technological limitation or to the availability source of local raw materials.  

```{r retouch}
retouch_as_proportion_of_all_artefacts <- round(nrow(retouch) / total_number_of_artefacts * 100, 1)

# compare mean dimensions of retouch and plain flakes
old_names <- colnames(flakes)
flakes_clean <- data.frame(flakes[,1:28], check.names = TRUE)
flakes_clean_summary <- 
flakes_clean %>% 
  mutate(retouch_complete = ifelse(flakes_clean$type == "ret", "Y", "N")) %>% 
  group_by(retouch_complete) %>% 
  summarise_if(is.numeric, mean, na.rm = TRUE)

basic_metrics <- c("length" , "max.dimension" , "Oriented.width" ,   "Width.at.25..max.dim" , "Width.at.50..max.dim" ,   "Width.at.75..max.dim" , "Oriented.thickness" ,   "Thickness.at.25..max.dim" ,   "Thickness.at.50..max.dim" ,   "Thickness.at.75..max.dim" , "mass" ,   "platform.width" , "platform.thickness" ,   "scar.number" , "cortex.percentage")

# look at basic metrics for complete flakes and complete retouched pieces
complete_flakes_retouch <- 
flakes_clean %>% 
  mutate(retouch_complete = ifelse(flakes_clean$type == "ret", "complete_retouch",       
                              ifelse(flakes_clean$type  == "flk", "complete_flake", "NA"))) %>%
  select(one_of(c("retouch_complete", basic_metrics))) %>% 
  gather(variable, value, -retouch_complete) %>% 
  filter(retouch_complete != "NA") 

# plot to see the variables by retouch vs non-retouch
plot_complete_flakes_retouch <- 
ggplot(complete_flakes_retouch,
       aes(retouch_complete,
             value)) +
    geom_boxplot()  +
    scale_y_log10() +
  facet_wrap( ~ variable, scales = "free_y")

# stat test on basic metric variables for retouch vs non-retouch flakes. Show variables with significant difference
library(broom)
t_test_retouch_non_retouch_metrics <- 
complete_flakes_retouch %>% 
  group_by(variable) %>% 
  do(tidy(t.test(value ~ retouch_complete, data=.))) %>% 
  arrange(p.value) %>% 
  filter(p.value < 0.05)
# retouch flakes are significantly longer, and thicker at all places where we measured thickness
```


```{r retouch_edge_shape}
           
# edge shape, check to see that number of edge shapes matches 
# count of edge shapes
retouch$`edge shape` <- gsub(" ", "", retouch$`edge shape`) # 1101
number_of_edge_shapes <- # 1101 items
map(retouch$`edge shape`, ~unlist(strsplit(., ",|\\."))) %>% 
  map_int(., length)

edge_checking <- data_frame(count_of_edges = retouch$`number of edge`,
           number_of_edge_shapes) # 1101 rows

edge_checking$diff <- with(edge_checking, count_of_edges - number_of_edge_shapes) # 1101
edge_checking$diffl <- ifelse(edge_checking$diff == 0, TRUE, FALSE) # 1101

# only get the retouched artefacts where the count of edges matches the number of edge types
retouch_edge_shapes <- retouch[ edge_checking$diffl, ] # 783 rows

# for all artefacts with 1 retouched edge, what shape is that?
retouch_edge_shapes_tally <- 
retouch_edge_shapes %>% 
  # filter(`number of edge` == 1) %>% 
  group_by(`edge shape`) %>% 
  tally() %>% 
  arrange(desc(n)) 

sum(retouch_edge_shapes_tally$n)

# join retouch to basic flakes to get retouch flake mass
flakes_clean_names <- flakes
names(flakes_clean_names) <- make.names(names(flakes_clean_names))
# retouch_edge_shapes$number <- gsub("f_", "", retouch_edge_shapes$number)
retouch_edge_shapes_metrics <- 
  left_join(retouch_edge_shapes, 
            flakes_clean_names, 
            by =  "number")
retouch_edge_shapes_metrics <- data.frame(retouch_edge_shapes_metrics, check.names = TRUE)

# investigate metrics by edge shape
retouch_edge_shapes_metrics_by_edge <- 
retouch_edge_shapes_metrics %>% 
  group_by(edge.shape) %>%
  mutate(count = n()) %>% # how many in each group?
  summarise_if(is.numeric, mean, na.rm = TRUE) %>% 
  arrange(desc(count))  # arrange from biggest group to smallest

# just look at the first five rows, and basic metrics

retouch_edge_shapes_basic_metrics_by_edge <- 
retouch_edge_shapes_metrics_by_edge[1:5, ]  %>% 
  select(one_of(c("edge.shape", basic_metrics)))

# Plot these
library(tidyr)
plot_retouch_edge_type_basic_metrics <- 
retouch_edge_shapes_metrics %>% 
  filter(edge.shape %in% retouch_edge_shapes_tally$`edge shape`[1:5]) %>% 
  select(one_of(c("edge.shape", basic_metrics))) %>% 
  gather(variable, value, -edge.shape) %>% 
  ggplot(aes(edge.shape,
             value)) +
    geom_boxplot() +
  facet_wrap( ~ variable, scales = "free_y")


# seems that it's not highly patterned, but maybe mass is worth a closer look
plot_retouch_edge_type_mass <- 
retouch_edge_shapes_metrics %>% 
  filter(edge.shape %in% retouch_edge_shapes_tally$`edge shape`[1:5]) %>% 
  select(one_of(c("edge.shape", "mass"))) %>% 
  gather(variable, value, -edge.shape) %>% 
  ggplot(aes(edge.shape,
             value)) +
    geom_boxplot()  +
  scale_y_log10()
# not a lot of difference 

# ANOVA to test for statistical difference
anova_on_edge_shape_and_metrics <- 
retouch_edge_shapes_metrics %>% 
  filter(edge.shape %in% retouch_edge_shapes_tally$`edge shape`[1:5]) %>% 
  select(one_of(c("edge.shape", basic_metrics))) %>% 
  gather(variable, value, -edge.shape) %>% 
  nest(-variable) %>% 
  mutate(anova = map(data, ~aov(value ~ edge.shape, data = .)))

# extract p-values and find the variable with significant different
anova_on_edge_shape_and_metrics_pvalues <- 
anova_on_edge_shape_and_metrics %>%
  mutate(model = map(anova, ~tidy(.x, data = .))) %>% 
  unnest(model) %>% 
  filter(term != "Residuals") %>% 
  filter( p.value <= 0.05)

anova_on_edge_shape_and_metrics_tukeyhsd <- 
anova_on_edge_shape_and_metrics %>% 
  filter(variable %in% anova_on_edge_shape_and_metrics_pvalues$variable) %>% 
  mutate(tukeyhsd = map(anova, 
                        ~tidy(TukeyHSD(.x, 
                                       data = ., 
                                       ordered = TRUE)))) %>% 
  unnest(tukeyhsd)  %>% 
  filter(adj.p.value <= 0.05)
```


```{r retouch_index_giur}

retouch_giur_per_section <- 
retouch %>% 
  select(grep("^number$|_t|_T", names(retouch))) %>% 
  gather(variable, value, -number) %>% 
  separate(variable, c("section", "tee"), sep = 10) %>% 
  spread(tee, value) %>% 
  mutate(t_T = t / T)  %>% 
  filter(t_T <= 1)

retouch_giur_per_artefact <- 
retouch_giur_per_section %>% 
  group_by(number) %>% 
  summarise(mean_giur = mean(t_T, na.rm = TRUE))

mean(retouch_giur_per_artefact$mean_giur)

# what percentage of retouched pieces have a GIUR greater than N
N <-  0.5
percentage_with_giur_greater_than_N <-
  round(mean(retouch_giur_per_artefact$mean_giur > N)  * 100, 0)


```



## Retouched pieces

A total of `r row(retouch)` retouched pieces were found in the assemblage, accounting for `r retouch_as_proportion_of_all_artefacts`% of lithic assemblage. The average max dimension is xxx. Compared with unretouched flakes, max dimensions and masses of retouched flake are smaller(Fig?). In terms of raw materials, retouched flakes made of chert are the smallest. Limestone is slightly larger than chert(Fig?).  % retouched pieces are made on flakes (%) and flake breaks (%), a small number of them are made on either chunks or pebbles. Side scrapers dominate the sub-division of retouched pieces (%), followed by denticulates and borers. Over % retouched pieces have more than 1 edge. The edge shapes of 1858 retouched edges were recorded from retouched pieces. The edge shapes include convex, concave, straight, denticulate, end, notch, borer. Among them, straight edge constitutes the largest proportion of the retouched edge (n=575 %) followed by convex(n=395) and concave(n=248)(significance of straight edge).We calculated the edge angle by measuring the width at the 3 mm depth of the edge. The average angle of each edge is?. Notably, there is amount of the edge angles are extreme steep which is not common in other site. This feature can be explained in two ways: 1) the lack of good quality raw materials leaded tool makers to elongate the lives of tools as long as possible, therefore, the edges had been retouched multiple times  after using; 2) they intended to produce the steep edge in order to apply to a special tusk.  Fig? and Fig? show the edge number distribution and edge shapes of each piece. The result shows that the majority of tools are not only retouched one edge, instead, they retouched several edges on one single piece. It also suggest the high efficient of exploit. Most of the layers of retouch is 1(n=760) and 2 (n=322).  Looking at the location of retouch and the size of the retouched flakes can provide us further insight into retouching behaviours. Most of tools have more than one retouched edges.  We introduced two concepts “Zone Index” and “Geometric Index of Unifacial Reduction(GIUR)” to estimate the invasion and intensity of retouching. From our observation… We also measured the angle of each retouched edge. For notch pieces(n=91), we found that most notches only have one notch end on each retouched piece and the average depth and length is xx and xx. The location of retouching is mainly on one side which defined as longer geometric side of the piece.  Except retouching with hard hammer percussing, pressing is also likely utilized demonstrated by flat and enlonged retouching scars. One remarkable feature of the retouching is demonstrated by a strong moustrian style with regular and continues retouching scars producing even edges on a large number of tools. In this assemblage, if a flake is retouched, the retouch tends to be extensive. This is suggested by the GIUR values. We found that `r percentage_with_giur_greater_than_N`% of retouched artefacts have a GIUR greater than `r N`.



### Indices

## Levallois 
We distinguished 70 stone artifacts that are Levallois like products including 11 cores, 22 flakes, 4 points and 33 tools made on levallois flakes. The average dimension of levallois products is xxx which is smaller (or larger) than ordinary products. The platform shapes of levallois flakes are various ranging from triangle, quadrangle, fusiformis to chapeau de gendarme(CDG). For flakes, we measured the thickness at 25%, 50%, 70% max dimension and compared them with ordinary flakes found that levallois flakes are relatively more flat. This found is consistent with the theory that ... The scar number is also relatively more than ordinary flakes, the direction of which is mostly centripetal. The platform of Levallois flakes and flake fragments are mainly plain(n=22), followed by facet(n=12) and the platform shapes are mainly CDG(n=15), followed by triangle(n=8) and quadrangle(n=6). The dorsal scar patterns can be divided into two main types: centripetal pattern which is covered by flake scars that are distributed centripetally and big scar pattern which is characterized by a giant scar from the same direction covering the most part of the dorsal area with proximal parts of centripetal scars on the margin(Fig?). Generally, the later pattern ends up with a relative flatter body and more possibilities of CDG platform shape. The configuration of levallois cores volumes were maintained through the detachment of predetermining Levallois and trimming striking platform flakes. The average max dimension is 82mm. Most of their platforms are facet(n=5). These cores are classified as Levallois is accorded to several key technical criteria (Boeda,1994) : 1) the flaking surface is maintained through predetermined flake scars that is arranged centripetally; 2) the fracture plane of detachment are almost parallel to the plane of intersection of the upper and lower surface; 3) and the two surface are hierarchicaly related. More than half of these cores retain a portion of cortex on the surface. The average scar number of each core is 4.5, and the average length of these scars is 40mm. 12 discoid cores are also found in the assemblage which are separated with Levallois cores. Although most of discoid cores also share similar features with Levallois, based on the 5 criteria definited by Boeda, it is more reasonable to classify them to discoid. 

# Discussion

1) Comparing with other sites in south China, Guanyindong is featured by the appearance of Levallois technique.Why do you think Gyd has levallois? Previous results from other sites in South China suggest that they have no levallois techinique (give examples and discussions)

2) In the lithic assemblage, we found 59 Levallois flakes, 11 Levallois cores, with distinguishable characters from Europe and Africa(less proportion, relative more proto morphology). What are the main difference between Gyd and other sites. What is the implication of such difference. Are there any difference in the Levallois techniques in Europe and Africa or other Asia sites?

3) Provide detailed discussion on the Demographic model, and explain the reason why Levallois technique in Southeast Asia is different from western. China and Southeast Asia is geographically distant from East Africa where Levallois technique is originated, as hominids dispersal from western to eastern, progressively smaller population, drastic changes of environment have made an inevitable influence on the style of Levallois technique. 

4) Drawbacks (assumptions) of the model. Other possible explanation you can offer.



# Conclusion
